<link rel="stylesheet" type="text/css" href="../../rs/flow/dayflow.css">
<div id="dayflow-top-view" class="flow3g-view">
    <div class="dayflow-row">选择查询日期: <input class="dayflow-querydate" type="date"/></div>
    <div class="dayflow-row">数据更新时间: <span class="dayflow-uptime">000000 00:00:00</span></div>
    <div class="dayflow-container">
        <div class="dayflow-table paper z-depth-1 rounded iccid_df">
            <div class="dft-tille">ICCID 下载排行</div>
            <table class="dft-grid">
                <thead>
                <tr>
                    <th>#</th>
                    <th>iccid</th>
                    <th class="number">下载(MB)</th>
                    <th class="number">上传(MB)</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
    <div class="dayflow-container">
        <div class="dayflow-table paper z-depth-1 rounded iccid_uf">
            <div class="dft-tille">ICCID 上传排行</div>
            <table class="dft-grid">
                <thead>
                <tr>
                    <th>#</th>
                    <th>iccid</th>
                    <th class="number">下载(MB)</th>
                    <th class="number">上传(MB)</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
    <div class="dayflow-container">
        <div class="dayflow-table paper z-depth-1 rounded mac_df">
            <div class="dft-tille">MAC 下载排行</div>
            <table class="dft-grid">
                <thead>
                <tr>
                    <th>#</th>
                    <th>mac</th>
                    <th class="number">下载(MB)</th>
                    <th class="number">上传(MB)</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
    <div class="dayflow-container">
        <div class="dayflow-table paper z-depth-1 rounded mac_uf">
            <div class="dft-tille">MAC 上传排名</div>
            <table class="dft-grid">
                <thead>
                <tr>
                    <th>#</th>
                    <th>mac</th>
                    <th class="number">下载(MB)</th>
                    <th class="number">上传(MB)</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
    <script>
        function myInit(args) {

            var $iccidUf = $('#dayflow-top-view .iccid_uf');
            var $iccidDf = $('#dayflow-top-view .iccid_df');
            var $macUf = $('#dayflow-top-view .mac_uf');
            var $macDf = $('#dayflow-top-view .mac_df');
            var $uptime = $('#dayflow-top-view .dayflow-uptime');
            var $qdate = $('#dayflow-top-view .dayflow-querydate');

            $('.dayflow-table').delegate('tbody .df-key', 'click', function () {
                var $df = $(this);
                var $mac = $df.find('.mac');
                var key = $mac.length > 0 ? $mac.html() : $df.html();
                window.open("/#/locationAndFlow.html?qt=" + key);
            });

            function report2html(rps) {
                var html = '';
                for (var i = 0, size = rps.length; i < size; i++) {
                    var rp = rps[i];
                    html += '<tr>';
                    html += '   <td>' + (i + 1) + '</td>';
                    html += '   <td class="df-key">' + (rp.iccid ? rp.iccid : ('<em class="mac">' + rp.mac + "</em>")) + '</td>';
                    html += '   <td class="number">' + rp.df1024 + '</td>';
                    html += '   <td class="number">' + rp.uf1024 + '</td>';
                    html += '</tr>';
                }
                return html;
            }

            function loadDayReport(date) {
                var date = date || new Date();
                var year = date.getFullYear();
                var month = date.getMonth() + 1;
                var day = date.getDate();
                var monthString = year + "" + $z.alignLeft(month, 2, '0');
                var dayString = $z.alignLeft(day, 2, '0');

                $http.post('/3g/df/get/dayreport', {
                    'month': monthString,
                    'day': dayString
                }, function (re) {
                    if (re.data) {
                        var report = re.data;
                        $uptime.html(report.ct);
                        // 更新table
                        $iccidUf.find('tbody')[0].innerHTML = report2html(report.icReportsUp);
                        $iccidDf.find('tbody')[0].innerHTML = report2html(report.icReportsDown);
                        $macUf.find('tbody')[0].innerHTML = report2html(report.macReportsUp);
                        $macDf.find('tbody')[0].innerHTML = report2html(report.macReportsDown);
                    } else {
                        $uptime.html("未生成数据");
                        $iccidUf.find('tbody')[0].innerHTML = "";
                        $iccidDf.find('tbody')[0].innerHTML = "";
                        $macUf.find('tbody')[0].innerHTML = "";
                        $macDf.find('tbody')[0].innerHTML = "";
                    }
                });
            }

            $qdate.on('change', function () {
                var ndate = $qdate.val();
                var regEx = new RegExp("\\-", "gi");
                ndate = ndate.replace(regEx, "/");
                loadDayReport(new Date(Date.parse(ndate)));
            });

            $qdate.val($z.dateToYYMMDD());
            loadDayReport();
        }
    </script>
</div>