<link rel="stylesheet" type="text/css" href="../../rs/flow/dayflow.css">
<div id="location-view" class="flow3g-view">
    <div class="dayflow-row">
        ICCID或MAC: <input class="dayflow-querylocation" type="text" value=""/>
    </div>
    <!--点位-->
    <div class="dayflow-container fullwidth">
        <div class="dayflow-chart-title">点位信息</div>
        <div class="dayflow-location  paper z-depth-1 rounded">
            <span>MAC</span>
            <input type="text" class="dayflow-location-info" nm="mac" disabled/>
            <span>ICCID</span>
            <input type="text" class="dayflow-location-info" nm="iccid" disabled/>
            <span>卡号</span>
            <input type="text" class="dayflow-location-info" nm="phone" disabled/>
            <span>服务器</span>
            <input type="text" class="dayflow-location-info" nm="server" disabled/>
            <span>域名</span>
            <input type="text" class="dayflow-location-info" nm="domain" disabled/>
            <span>盒子ID</span>
            <input type="text" class="dayflow-location-info" nm="boxId" disabled/>
            <span>盒子名称</span>
            <input type="text" class="dayflow-location-info" nm="boxName" disabled/>
            <span>盒子路径</span>
            <input type="text" class="dayflow-location-info" nm="boxPath" disabled/>
            <span>最后更新时间</span>
            <input type="text" class="dayflow-location-info" nm="uptime" disabled/>
        </div>
    </div>
    <!--最近七天-->
    <div class="dayflow-container fullwidth">
        <div class="dayflow-chart-title">今日流量</div>
        <div class="dayflow-chart  paper z-depth-1 rounded day1">
        </div>
    </div>
    <!--最近七天-->
    <div class="dayflow-container fullwidth">
        <div class="dayflow-chart-title">最近7天</div>
        <div class="dayflow-chart  paper z-depth-1 rounded day7">
        </div>
    </div>
    <!--最近一个月-->
    <div class="dayflow-container fullwidth">
        <div class="dayflow-chart-title">最近一个月</div>
        <div class="dayflow-chart  paper z-depth-1 rounded day30">
        </div>
    </div>
    <script src="../../rs/js/echarts-all.js"></script>
    <script>
        function myInit(args) {
            var $qloc = $('#location-view .dayflow-querylocation');
            var $locInfo = $('#location-view .dayflow-location');
            var $dc1 = $('#location-view .dayflow-chart.day1');
            var $dc7 = $('#location-view .dayflow-chart.day7');
            var $dc30 = $('#location-view .dayflow-chart.day30');
            var $dc1EChart = null;
            var $dc7EChart = null;
            var $dc30EChart = null;

            function resetChart($dcChart) {
                $dcChart.setOption({
                    xAxis: [
                        {
                            type: 'category',
                            boundaryGap: false,
                            scale: true,
                            data: ['0']
                        }
                    ],
                    yAxis: [
                        {
                            type: 'value'
                        }
                    ],
                    tooltip: {
                        trigger: 'axis'
                    },
                    legend: {
                        data: ['上传', '下载']
                    },
                    series: [
                        {
                            name: '上传',
                            type: 'line',
                            data: [0]
                        },
                        {
                            name: '下载',
                            type: 'line',
                            data: [0]
                        }]
                });
            }

            function loadChart(dn, $dcChart) {
                $http.get('/3g/df/diagram/day/' + $.trim($qloc.val()) + "/" + dn, function (re) {
                    if (re.data) {
                        var fDiagram = re.data;
                        for (var i = 0, size = fDiagram.days.length; i < size; i++) {
                            fDiagram.days[i] = fDiagram.days[i].substr(4);
                            fDiagram.upflows[i] = fDiagram.upflows[i].toFixed(2);
                            fDiagram.downflows[i] = fDiagram.downflows[i].toFixed(2);
                        }
                        $dcChart.setOption({
                            xAxis: [
                                {
                                    type: 'category',
                                    boundaryGap: true,
                                    scale: true,
                                    data: fDiagram.days
                                }
                            ],
                            yAxis: [
                                {
                                    type: 'value',
                                    axisLabel: {
                                        formatter: '{value} MB'
                                    }
                                }
                            ],
                            tooltip: {
                                trigger: 'axis'
                            },
                            legend: {
                                data: ['上传', '下载']
                            },
                            series: [
                                {
                                    name: '上传',
                                    type: 'line',
                                    data: fDiagram.upflows
                                },
                                {
                                    name: '下载',
                                    type: 'line',
                                    data: fDiagram.downflows
                                }]
                        });
                    } else {
                        resetChart($dcChart);
                    }
                });
            }

            function resetLocation() {
                $locInfo.find('input').val("");
            }

            function loadLocation(key) {
                $http.get("/3g/df/location/query/key/" + key, function (re) {
                    if (re.data) {
                        $locInfo.find('input').each(function (i, ele) {
                            var $ci = $(ele);
                            var nm = $ci.attr('nm');
                            if (re.data[nm]) {
                                $ci.val(re.data[nm]);
                            } else {
                                $ci.val('');
                            }
                        });
                    } else {
                        resetLocation();
                    }
                });
            }

            $qloc.on('change', function () {
                var key = $.trim($qloc.val());
                // 检查点位信息
                $http.get("/3g/iccid/check/" + key, function (re) {
                    if (re.data) {
                        // 检查点位信息
                        loadLocation(key)
                        // 检查7天流量
                        loadChart(7, $dc7EChart);
                        // 检查30天流量
                        loadChart(30, $dc30EChart);
                    } else {
                        resetChart($dc7EChart);
                        resetChart($dc30EChart);

                        alert('搜索的点位信息不存在');
                    }
                });
            });

            setTimeout(function () {
                if (!$dc7EChart) {
                    $dc7EChart = echarts.init($dc7[0]);
                    resetChart($dc7EChart);
                }
                if (!$dc30EChart) {
                    $dc30EChart = echarts.init($dc30[0]);
                    resetChart($dc30EChart);
                }

                if (args != null && args.qt) {
                    $qloc.val(args.qt).trigger('change');
                }
            }, 200);
        }
    </script>
</div>