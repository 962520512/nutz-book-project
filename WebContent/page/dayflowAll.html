<link rel="stylesheet" type="text/css" href="../../rs/flow/dayflow.css">
<div id="dayflow-all-view" class="flow3g-view">
    <div class="dayflow-row" style="padding-left: 12px">选择查询日期: <input class="dayflow-querydate" type="date"/></div>
    <div class="dayflow-row">
        <div class="md-checkbox-field check-left has-checked">
            <div class="checkbox-wrap">
                <i class="md-icon checked"></i>
                <i class="md-icon unchecked"></i>
                <input name="asIccid" type="checkbox" checked>
            </div>
            <label>iccid</label>
        </div>
        <div class="md-checkbox-field check-left has-checked">
            <div class="checkbox-wrap">
                <i class="md-icon checked"></i>
                <i class="md-icon unchecked"></i>
                <input name="order" type="checkbox" checked>
            </div>
            <label>download</label>
        </div>
    </div>
    <div class="dayflow-container fullwidth">
        <div class="dayflow-table paper z-depth-1 rounded flow_df">
            <div class="dft-tille">流量排行(从高到低)</div>
            <table class="dft-grid">
                <thead>
                <tr>
                    <th>#</th>
                    <th>iccid or mac</th>
                    <th class="number">下载(MB)</th>
                    <th class="number">上传(MB)</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
    <script>
        function myInit(args) {

            var $flowdf = $('#dayflow-all-view .flow_df');
            var $qdate = $('#dayflow-all-view .dayflow-querydate');
            var $orderby = $('#dayflow-all-view input[name=order]');
            var $iccid = $('#dayflow-all-view input[name=asIccid]');

            $('.dayflow-table').delegate('tbody .df-key', 'click', function () {
                var $df = $(this);
                var $mac = $df.find('.mac');
                var key = $mac.length > 0 ? $mac.html() : $df.html();
                window.open("/#/locationAndFlow.html?qt=" + key);
            });

            function report2html(rps) {
                var html = '';
                for (var i = 0, size = rps.length; i < size; i++) {
                    var rp = rps[i];
                    html += '<tr>';
                    html += '   <td>' + (i + 1) + '</td>';
                    html += '   <td class="df-key">' + (rp.iccid ? rp.iccid : ('<em class="mac">' + rp.mac + "</em>")) + '</td>';
                    html += '   <td class="number">' + rp.df1024 + '</td>';
                    html += '   <td class="number">' + rp.uf1024 + '</td>';
                    html += '</tr>';
                }
                return html;
            }

            function loadDayReport(date) {
                var date = date || new Date();
                var year = date.getFullYear();
                var month = date.getMonth() + 1;
                var day = date.getDate();
                var monthString = year + "" + $z.alignLeft(month, 2, '0');
                var dayString = $z.alignLeft(day, 2, '0');

                $http.post('/3g/df/query/dayreport', {
                    'month': monthString,
                    'day': dayString,
                    'asIccid': $iccid.prop('checked'),
                    'order': $orderby.prop('checked') ? "downflow" : "upflow"
                }, function (re) {
                    if (re.data) {
                        // 更新table
                        $flowdf.find('tbody')[0].innerHTML = report2html(re.data);
                    } else {
                        $flowdf.find('tbody')[0].innerHTML = "";
                    }
                });
            }

            function loadByQdate() {
                var ndate = $qdate.val();
                var regEx = new RegExp("\\-", "gi");
                ndate = ndate.replace(regEx, "/");
                loadDayReport(new Date(Date.parse(ndate)));
            }

            $qdate.on('change', loadByQdate);
            $orderby.on('change', loadByQdate);
            $iccid.on('change', loadByQdate);

            $qdate.val($z.dateToYYMMDD());
            loadDayReport();
        }
    </script>
</div>